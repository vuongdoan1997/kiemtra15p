<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÔN TẬP TRẮC NGHIỆM TIN 11 - BÀI 4 (KNTT CS & ICT)</title>
    <style>
        /* CSS được tinh chỉnh để bài quiz hiển thị độc lập */
        body {
            font-family: cambria, Arial, sans-serif;
            font-size: 14pt;
            line-height: 1.3;
            padding: 20px;
            background-color: #f4f4f4;
            color: #333;
        }
        .container {
            max-width: 900px; 
            margin: auto;
            background: #fff;
            padding: 10px;
            border-radius: 8px;
            box-shadow: 0 0 15px rgba(0,0,0,0.2);
        }
        /* CSS cho Form Thông tin Học sinh */
        #userInfoFormContainer { padding: 30px; }
        #userInfoForm .form-group { margin-bottom: 20px; }
        #userInfoForm label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #0056b3;
        }
        #userInfoForm input[type="text"] {
            width: 100%;
            padding: 12px;
            border: 1px solid #ccc;
            border-radius: 5px;
            font-size: 14pt;
            font-family: cambria;
        }
        #userInfoForm .start-btn {
            display: block;
            width: 220px;
            padding: 12px;
            font-size: 16px;
            font-family: cambria;
            background-color: #28a745;
            color: #fff;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin: 20px auto 0;
            transition: background-color 0.3s;
        }
        #userInfoForm .start-btn:hover { background-color: #218838; }
        
        /* CSS chung cho bài Quiz */
        h1 { color: #0056b3; text-align: center; margin-top: 5px; margin-bottom: 0px; }
        h2 { color: #0056b3; text-align: center; margin-top: 0px; margin-bottom: 20px; }
        .timer {
            position: sticky;
            top: 0;
            z-index: 1000;
            background-color: #F2F2F2;
            padding: 10px 15px;
            border-bottom: 4px solid #d9534f;
            text-align: center;
            font-size: 24px;
            font-weight: bold;
            color: red;
            margin: -10px -10px 20px -10px;
            border-radius: 8px 8px 0 0;
        }
        .question {
            margin-bottom: 15px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background-color: #f9f9f9;
        }
        .question p { font-weight: bold; margin-bottom: 10px; margin-top: 0px; }
        .options-container { display: grid; gap: 5px; }
        .option-label {
            display: flex;
            align-items: center;
            padding: 10px;
            background-color: #fff;
            border: 1px solid #ccc;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        .option-label:hover { background-color: #e9e9e9; }
        .option-label input { margin-right: 10px; }
        .submit-btn {
            display: block;
            width: 220px;
            padding: 10px;
            font-size: 16px;
            font-family: cambria;
            background-color: #007BFF;
            color: #fff;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin: 20px auto 0; /* Thêm margin-top */
            transition: background-color 0.3s;
        }
        .submit-btn:hover { background-color: #0056b3; }
        
        /* CSS cho phần Kết quả */
        .results { margin-top: 30px; border-top: 2px solid #333; padding-top: 20px; display: none; }
        #studentInfoResults {
            font-size: 16pt;
            padding: 1px 15px;
            background-color: #eaf2f9;
            border-left: 5px solid #007BFF;
            margin-bottom: 20px;
        }
        .result-item {
            margin-bottom: 20px;
            padding: 15px;
            border-left: 5px solid;
            background-color: #fafafa;
        }
        .result-item.correct { border-left-color: #28a745; }
        .result-item.incorrect { border-left-color: #dc3545; }
        .explanation {
            font-style: italic;
            color: #555;
            margin-top: 10px;
            padding: 10px;
            background-color: #eaf2f9;
            border-radius: 4px;
        }
        .correct-answer-text { font-weight: bold; color: #28a745; }
        .your-answer-text { font-weight: bold; color: #dc3545; }
        .true-false-container { margin-top: 15px; }
        .true-false-container .option-label { display: inline-flex; width: auto; margin-right: 10px; }
        .true-false-container .sub-question-text { font-weight: normal; }
        .option-label.correct { background-color: #d4edda; border-color: #c3e6cb; }
        .option-label.incorrect { background-color: #f8d7da; border-color: #f5c6cb; }
    </style>
</head>
<body>
    <div class="container">
        <div id="userInfoFormContainer">
            <h1>THÔNG TIN HỌC SINH</h1>
            <h2>Vui lòng điền đầy đủ thông tin bên dưới</h2>
            <div id="userInfoForm">
                <div class="form-group">
                    <label for="studentName">Họ và Tên:</label>
                    <input type="text" id="studentName" name="studentName" required>
                </div>
                <div class="form-group">
                    <label for="studentClass">Lớp:</label>
                    <input type="text" id="studentClass" name="studentClass" required>
                </div>
                <button type="button" id="startBtn" class="start-btn"><b>Bắt đầu làm bài</b></button>
            </div>
        </div>

        <div id="quizContainer" style="display:none;">
            <h1>ÔN TẬP TRẮC NGHIỆM</h1>
            <h2>Bài 4. BÊN TRONG MÁY TÍNH</h2>
            
            <div class="timer">Thời gian còn lại: <span id="countdown">15:00</span></div>

            <form id="quizForm">
                
                <div style="background-color: azure; color: green; padding: 5px; text-align: justify;">
                    <b>PHẦN I. Thí sinh trả lời từ câu 1 đến câu 12. Mỗi câu thí sinh chỉ chọn một phương án.</b>
                </div>
                <div id="part1-questions"></div>
                
                <div style="background-color: azure; color: green; padding: 5px; text-align: justify; margin-top: 20px;">
                    <b>PHẦN II. Thí sinh trả lời từ câu 13 đến câu 16. Trong mỗi ý a), b), c), d) ở mỗi câu, thí sinh chọn đúng hoặc sai</b>
                </div>
                <div id="part2-questions"></div>

                <button type="submit" class="submit-btn"><b>Nộp bài và xem kết quả</b></button>
            </form>

            <div class="results" id="results">
                <h2>THÔNG TIN BÀI LÀM CỦA BẠN</h2>
                <div id="studentInfoResults"></div> 
                <div id="score"></div>
                <div id="resultDetails"></div>
            </div>
        </div>
    </div>

    <script>
        // --- CẤU HÌNH GOOGLE FORM CỦA BẠN ---
        const GOOGLE_FORM_ACTION_URL = "https://docs.google.com/forms/u/0/d/e/1FAIpQLSc09y40H6BEgtLqI3R1Q04F8kljeqHX4Bij1G7sIlqk_Fmw5A/formResponse";
        const ENTRY_ID_NAME = "entry.699633454";   
        const ENTRY_ID_CLASS = "entry.371774655";  
        const ENTRY_ID_SCORE = "entry.46168601";   

        // --- KHỐI DỮ LIỆU CÂU HỎI (Bài 4) ---
                const quizData = {
            part1: [
                // --- NHẬN BIẾT (5 CÂU) ---
                { id: 'q1', question: 'Thành phần nào được coi là "bộ não" của máy tính, đảm nhận việc thực hiện các chương trình?', options: ['RAM', 'Đĩa cứng', 'Bảng mạch chính', 'CPU'], answer: 'CPU', explanation: 'Tài liệu định nghĩa CPU (Bộ xử lí trung tâm) là "thành phần quan trọng nhất của máy tính, đảm nhận việc thực hiện các chương trình máy tính".' },
                { id: 'q2', question: 'Tốc độ của CPU thường được đo bằng đơn vị nào?', options: ['Gigabyte (GB)', 'Gigahertz (GHz)', 'Megabit trên giây (Mbps)', 'Vòng quay mỗi phút (RPM)'], answer: 'Gigahertz (GHz)', explanation: 'Bài học nêu rõ: "người ta thường dùng tần số đồng hồ xung, thường là GHz (1 tỉ xung một giây) để đánh giá tốc độ của CPU".' },
                { id: 'q3', question: 'Loại bộ nhớ trong nào sẽ bị xóa dữ liệu khi tắt máy?', options: ['ROM', 'RAM', 'SSD', 'Đĩa cứng'], answer: 'RAM', explanation: 'Tài liệu ghi: "khi tắt máy, dữ liệu trong RAM sẽ bị xoá".' },
                { id: 'q4', question: 'Mạch lôgic thực hiện phép toán "chỉ cho kết quả là 1 khi và chỉ khi cả hai đầu vào đều bằng 1" là mạch nào?', options: ['OR', 'NOT', 'AND', 'XOR'], answer: 'AND', explanation: 'Định nghĩa trong bài: "Phép nhân hai đại lượng lôgic chỉ nhận giá trị 1 khi và chỉ khi cả hai đại lượng x VÀ y đều bằng 1". Mạch AND thực hiện phép nhân lôgic.' },
                { id: 'q5', question: 'Tất cả các thiết bị bên trong thân máy được gắn với một bảng mạch lớn gọi là gì?', options: ['Bảng mạch mở rộng', 'Bảng mạch chính (mainboard)', 'Cáp nối', 'Cổng kết nối'], answer: 'Bảng mạch chính (mainboard)', explanation: 'Sách giáo khoa nêu: "Tất cả các thiết bị bên trong thân máy được gắn với một bảng mạch, gọi là bảng mạch chính (mainboard)".' },
                
                // --- THÔNG HIỂU (4 CÂU) ---
                { id: 'q6', question: 'Tại sao CPU đa lõi (multi-core) cho phép máy tính xử lí nhanh hơn?', options: ['Vì mỗi lõi có tốc độ GHz cao hơn.', 'Vì nó có thể thực hiện song song nhiều công việc cùng một lúc.', 'Vì nó tiêu thụ ít điện năng hơn.', 'Vì nó có dung lượng bộ nhớ đệm lớn hơn.'], answer: 'Vì nó có thể thực hiện song song nhiều công việc cùng một lúc.', explanation: 'Tài liệu giải thích rằng CPU đa lõi "cho phép máy tính xử lí nhanh hơn vì có thể thực hiện song song nhiều công việc". Mỗi lõi là một đơn vị xử lí.' },
                { id: 'q7', question: 'Sự khác biệt cơ bản giữa bộ nhớ trong (RAM) và bộ nhớ ngoài (đĩa cứng) là gì?', options: ['RAM nhanh hơn nhưng không lưu được dữ liệu lâu dài khi mất điện, còn đĩa cứng chậm hơn nhưng lưu được dữ liệu lâu dài.', 'RAM dùng để lưu trữ hệ điều hành, còn đĩa cứng dùng để lưu trữ ứng dụng.', 'RAM có dung lượng lớn hơn đĩa cứng.', 'RAM là thiết bị cơ còn đĩa cứng là thiết bị điện tử.'], answer: 'RAM nhanh hơn nhưng không lưu được dữ liệu lâu dài khi mất điện, còn đĩa cứng chậm hơn nhưng lưu được dữ liệu lâu dài.', explanation: 'RAM là bộ nhớ tạm thời, tốc độ cao cho các chương trình đang chạy. Bộ nhớ ngoài (đĩa cứng) dùng để lưu dữ liệu lâu dài, không cần nguồn nuôi, nhưng tốc độ truy cập chậm hơn.' },
                { id: 'q8', question: 'Chức năng của bộ nhớ đệm (cache) trong CPU là gì?', options: ['Lưu trữ vĩnh viễn các chương trình.', 'Tăng dung lượng của bộ nhớ RAM.', 'Chứa dữ liệu được nạp trước từ bộ nhớ trong nhằm giảm thời gian đọc dữ liệu của CPU.', 'Thực hiện các phép toán số học.'], answer: 'Chứa dữ liệu được nạp trước từ bộ nhớ trong nhằm giảm thời gian đọc dữ liệu của CPU.', explanation: 'Bài học định nghĩa bộ nhớ đệm là "một bộ nhớ nhỏ chứa dữ liệu được nạp trước từ bộ nhớ trong nhằm giảm thời gian đọc dữ liệu".' },
                { id: 'q9', question: 'Tại sao có thể nói mọi mạch lôgic đều có thể được xây dựng từ các cổng AND, OR, và NOT?', options: ['Vì chỉ ba cổng này mới có thể chế tạo được bằng rơ le.', 'Vì ba cổng này tương ứng với ba phép toán cơ bản nhất và các phép toán phức tạp hơn (như XOR) có thể được tổng hợp từ chúng.', 'Vì ba cổng này tiêu thụ ít điện năng nhất.', 'Vì ba cổng này có kí hiệu đơn giản nhất.'], answer: 'Vì ba cổng này tương ứng với ba phép toán cơ bản nhất và các phép toán phức tạp hơn (như XOR) có thể được tổng hợp từ chúng.', explanation: 'Tài liệu khẳng định rằng: "bất cứ mạch lôgic nào cũng có thể xây dựng được từ các cổng AND, OR, NOT".' },

                // --- VẬN DỤNG (3 CÂU) ---
                { id: 'q10', question: 'Thực hiện phép cộng nhị phân 1011 + 101. Kết quả trong hệ nhị phân là bao nhiêu?', options: ['1111', '10000', '1100', '10110'], answer: '10000', explanation: 'Thực hiện cộng từ phải sang trái: 1+1=10 (viết 0 nhớ 1); 1+0+1(nhớ)=10 (viết 0 nhớ 1); 0+1+1(nhớ)=10 (viết 0 nhớ 1); 1+1(nhớ)=10 (viết 10). Kết quả là 10000. (Tương đương 11 + 5 = 16).' },
                { id: 'q11', question: 'Một người dùng muốn nâng cấp máy tính để chơi game mượt hơn. Game yêu cầu xử lí đồ họa phức tạp và tải nhiều dữ liệu game. Giữa việc nâng cấp CPU từ 2 lõi lên 4 lõi và nâng cấp RAM từ 8 GB lên 16 GB, lựa chọn nào có thể mang lại hiệu quả rõ rệt hơn?', options: ['Nâng cấp CPU, vì nhiều lõi hơn sẽ xử lí đồ họa tốt hơn.', 'Nâng cấp RAM, vì dung lượng RAM lớn hơn cho phép tải và truy cập dữ liệu game nhanh hơn, tránh giật lag.', 'Cả hai đều không có tác dụng.', 'Chỉ cần mua một đĩa cứng mới.'], answer: 'Nâng cấp RAM, vì dung lượng RAM lớn hơn cho phép tải và truy cập dữ liệu game nhanh hơn, tránh giật lag.', explanation: 'Trong khi CPU quan trọng, việc thiếu RAM là nguyên nhân phổ biến gây giật lag trong game do máy tính phải liên tục đọc dữ liệu từ bộ nhớ ngoài chậm hơn. Nâng cấp RAM sẽ giúp chứa nhiều dữ liệu game hơn để truy cập nhanh.' },
                { id: 'q12', question: 'Xét một mạch lôgic có hai đầu vào x, y và một đầu ra z. Mạch được cấu tạo bởi một cổng AND nối với hai đầu vào, và một cổng NOT nối vào đầu ra của cổng AND. Nếu đầu vào là x=1, y=1, thì đầu ra z sẽ là bao nhiêu?', options: ['0', '1', 'Không xác định', 'Cả 0 và 1'], answer: '0', explanation: 'Với x=1 và y=1, cổng AND sẽ cho đầu ra là 1. Tín hiệu 1 này sau đó đi qua cổng NOT, cổng NOT sẽ đảo ngược tín hiệu thành 0. Vậy đầu ra cuối cùng z là 0.' }
            ],
            part2: [
                { id: 'q13', question: 'Một bạn học sinh tên An đang tìm hiểu để tự lắp ráp một máy tính cá nhân. An biết rằng tất cả các linh kiện như CPU, RAM, và đĩa cứng đều phải được kết nối vào bảng mạch chính. An đang phân vân giữa việc sử dụng ổ đĩa SSD hay ổ đĩa cứng (HDD) cho hệ điều hành.', sub_questions: [
                    { id: 'a', text: 'Thiết bị đảm nhận việc thực hiện các phép tính số học và lôgic trong máy tính của An là bộ ALU bên trong CPU.', answer: 'true', explanation: 'Tài liệu ghi rõ bộ ALU (Bộ số học và lôgic) là bộ phận của CPU thực hiện tất cả các phép tính số học và lôgic.' },
                    { id: 'b', text: 'RAM là một loại bộ nhớ ngoài, giống như đĩa cứng.', answer: 'false', explanation: 'RAM là bộ nhớ trong. Bộ nhớ ngoài thường là đĩa từ (đĩa cứng), đĩa thể rắn (SSD), hoặc đĩa quang.' },
                    { id: 'c', text: 'Việc lựa chọn ổ SSD thay vì HDD sẽ giúp máy tính khởi động nhanh hơn đáng kể vì SSD có thời gian truy cập trung bình nhỏ hơn nhiều so với HDD.', answer: 'true', explanation: 'Tài liệu so sánh và chỉ ra rằng "tốc độ truy cập (của HDD) chậm hơn nhiều so với đĩa SSD". Thời gian truy cập nhanh hơn giúp tải hệ điều hành và ứng dụng nhanh hơn.' },
                    { id: 'd', text: 'Nếu An chọn CPU có tốc độ 3.0 GHz, điều đó có nghĩa là CPU thực hiện được đúng 3 tỉ phép tính trong một giây.', answer: 'false', explanation: 'Tốc độ GHz là tần số đồng hồ xung (3 tỉ xung một giây). Một phép tính có thể cần một hoặc nhiều xung đồng hồ để hoàn thành, do đó không thể nói nó thực hiện được đúng 3 tỉ phép tính.' }
                ]},
                { id: 'q14', question: 'Trong một nhà máy thông minh, một hệ thống an toàn sử dụng các cảm biến và mạch lôgic để điều khiển. Một cánh tay robot chỉ được phép hoạt động (đầu ra R=1) khi có tín hiệu từ cảm biến an toàn (x=1) VÀ cảm biến sản phẩm (y=1). Hệ thống này được xây dựng từ các cổng lôgic cơ bản.', sub_questions: [
                    { id: 'a', text: 'Các đại lượng lôgic từ cảm biến x và y chỉ có thể nhận một trong hai giá trị là 0 hoặc 1.', answer: 'true', explanation: 'Bài học nêu rõ: "Các đại lượng lôgic là các đại lượng chỉ nhận một trong hai giá trị lôgic là Đúng và Sai, được thể hiện tương ứng bởi các bit 1 và 0".' },
                    { id: 'b', text: 'Mối quan hệ "VÀ" trong yêu cầu của hệ thống tương ứng với phép toán lôgic OR.', answer: 'false', explanation: 'Mối quan hệ "VÀ" tương ứng với phép toán lôgic AND (phép nhân). Phép OR tương ứng với "HOẶC".' },
                    { id: 'c', text: 'Toàn bộ hệ thống điều khiển của nhà máy, bao gồm cả các mạch lôgic phức tạp, về cơ bản đều được chế tạo từ sự kết hợp của các cổng AND, OR và NOT.', answer: 'true', explanation: 'Tài liệu nhấn mạnh tầm quan trọng của mạch lôgic và khẳng định "Tất cả các thiết bị số, gồm cả máy tính đều được chế tạo từ các mạch lôgic" và chúng đều có thể xây dựng từ 3 cổng cơ bản.' },
                    { id: 'd', text: 'Nếu đầu vào cảm biến là x=1 và y=0, thì cánh tay robot sẽ hoạt động (R=1).', answer: 'false', explanation: 'Áp dụng phép toán AND: R = x AND y = 1 AND 0 = 0. Vì một trong hai đầu vào là 0, kết quả là 0, tức là cánh tay robot sẽ không hoạt động.' }
                ]},
                { id: 'q15', question: 'Một máy tính được trang bị CPU 4 nhân, 16 GB RAM và 1 TB ổ cứng. Khi người dùng chạy một chương trình chỉnh sửa video, CPU sẽ thực hiện hàng tỉ phép tính để xử lí các khung hình, trong khi RAM sẽ lưu trữ tạm thời các đoạn video đang được chỉnh sửa để truy cập nhanh.', sub_questions: [
                    { id: 'a', text: '16 GB RAM là thông số chỉ dung lượng của bộ nhớ trong.', answer: 'true', explanation: 'Dung lượng của bộ nhớ trong (RAM) thường được tính theo MB, GB. 16 GB là một dung lượng RAM phổ biến.' },
                    { id: 'b', text: 'ROM là bộ phận chính được sử dụng để lưu các đoạn video đang chỉnh sửa trong ví dụ này.', answer: 'false', explanation: 'RAM được dùng để ghi dữ liệu tạm thời trong khi chạy các chương trình. ROM là bộ nhớ chỉ đọc, chứa các chương trình khởi động máy tính.' },
                    { id: 'c', text: 'Việc CPU có 4 nhân giúp chương trình chỉnh sửa video hoạt động hiệu quả hơn vì nó có thể phân chia các tác vụ xử lí video cho các nhân khác nhau thực hiện đồng thời.', answer: 'true', explanation: 'CPU đa lõi (nhiều nhân) cho phép thực hiện song song nhiều công việc. Trong chỉnh sửa video, các tác vụ như render, áp dụng hiệu ứng có thể được thực hiện song song để tăng tốc độ.' },
                    { id: 'd', text: 'Dung lượng ổ cứng 1 TB tương đương với chính xác 1000 GB.', answer: 'false', explanation: 'Theo các đơn vị đo lường trong tin học, 1 Terabyte (TB) bằng 1024 Gigabyte (GB), không phải 1000 GB.' }
                ]},
                { id: 'q16', question: 'Bộ phận ALU bên trong CPU là nơi thực hiện các phép toán số học nhị phân. Để thực hiện phép cộng hai số nhị phân, ALU sử dụng các mạch lôgic được tạo thành từ các cổng AND, OR, NOT, XOR. Ví dụ, để cộng hai bit x và y, mạch cần có hai đầu ra: một cho kết quả (t) và một cho số nhớ (z).', sub_questions: [
                    { id: 'a', text: 'Theo bảng cộng nhị phân, kết quả của phép tính 1 + 1 là 10.', answer: 'true', explanation: 'Bảng cộng trong Hình 4.8 cho thấy khi x=1 và y=1, kết quả là 10 (tức là kết quả t=0 và số nhớ z=1).' },
                    { id: 'b', text: 'Phép toán lôgic để tính ra số nhớ z khi cộng hai bit x và y là phép OR.', answer: 'false', explanation: 'Số nhớ z chỉ bằng 1 khi cả x và y đều bằng 1. Đây là kết quả của phép toán x AND y.' },
                    { id: 'c', text: 'Giá trị của bit kết quả t (không tính số nhớ) chính là kết quả của phép toán x XOR y.', answer: 'true', explanation: 'So sánh bảng cộng và bảng phép toán lôgic, bit kết quả t là 1 khi x và y khác nhau (0+1=1, 1+0=1) và là 0 khi x và y giống nhau (0+0=0, 1+1=0). Đây chính là định nghĩa của phép XOR.' },
                    { id: 'd', text: 'Nếu ta thực hiện phép cộng 110 (6) + 111 (7) trong hệ nhị phân, kết quả sẽ là 1101 (13).', answer: 'true', explanation: 'Hình 4.9 trong tài liệu đã minh họa chính xác phép cộng này và cho ra kết quả là 1101, tương đương 6 + 7 = 13 trong hệ thập phân.' }
                ]}
            ]
        };

        // --- KHAI BÁO BIẾN TOÀN CỤC ---
        let studentName = '', studentClass = '';
        let shuffledPart1Data, shuffledPart2Data;

        // SỬA LỖI 1: Thêm lại các biến cần thiết cho timer
        const timeLimit = 15 * 60; // 15 phút
        let timeLeft = timeLimit;
        let timerInterval;


        function shuffle(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        function buildQuiz() {
            const part1Container = document.getElementById('part1-questions');
            const part2Container = document.getElementById('part2-questions');
            
            let part1Html = '';
            shuffledPart1Data = shuffle([...quizData.part1]);
            shuffledPart1Data.forEach((q, index) => {
                const shuffledOptions = shuffle([...q.options]);
                const optionsHtml = shuffledOptions.map(opt => {
                    const escapedOpt = opt.replace(/"/g, '&quot;');
                    return `
                        <label class="option-label">
                            <input type="radio" name="${q.id}" value="${escapedOpt}"> ${opt}
                        </label>
                    `;
                }).join('');

                part1Html += `
                    <div class="question" id="${q.id}">
                        <p><strong>Câu ${index + 1}:</strong> ${q.question}</p>
                        <div class="options-container">${optionsHtml}</div>
                    </div>
                `;
            });
            part1Container.innerHTML = part1Html;
            
            let part2Html = '';
            shuffledPart2Data = shuffle([...quizData.part2]);
            shuffledPart2Data.forEach((q, index) => {
                const subQuestionsHtml = q.sub_questions.map(sub => `
                    <div class="true-false-container">
                        <p class="sub-question-text">${sub.id}) ${sub.text}</p>
                        <label class="option-label"><input type="radio" name="${q.id}_${sub.id}" value="true"> Đúng</label>
                        <label class="option-label"><input type="radio" name="${q.id}_${sub.id}" value="false"> Sai</label>
                    </div>
                `).join('');

                part2Html += `
                    <div class="question" id="${q.id}">
                        <p><strong>Câu ${shuffledPart1Data.length + index + 1}:</strong> ${q.question}</p>
                        ${subQuestionsHtml}
                    </div>
                `;
            });
            part2Container.innerHTML = part2Html;
        }

        function startTimer() {
            const countdownElement = document.getElementById('countdown');
            timerInterval = setInterval(() => {
                // Hiển thị thời gian trước khi giảm
                const minutes = Math.floor(timeLeft / 60);
                const seconds = timeLeft % 60;
                countdownElement.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;

                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                    alert("Đã hết giờ làm bài! Hệ thống sẽ tự động nộp bài của bạn.");
                    submitQuiz(new Event('submit')); // Tạo một event giả để nộp bài
                } else {
                    timeLeft--;
                }
            }, 1000);
        }

        function stopTimer() {
            clearInterval(timerInterval);
        }
        
        function getQuestionScore(correctCount) {
            switch (correctCount) {
                case 1: return 0.1;
                case 2: return 0.25;
                case 3: return 0.5;
                case 4: return 1.0;
                default: return 0.0;
            }
        }

        function submitQuiz(event) {
            // Ngăn chặn hành vi mặc định của form là tải lại trang
            if (event) {
                event.preventDefault();
            }

            stopTimer();
            let score = 0;
            const resultSection = document.getElementById('results');
            const resultDetails = document.getElementById('resultDetails');
            const scoreElement = document.getElementById('score');
            
            const studentInfoResults = document.getElementById('studentInfoResults');
            studentInfoResults.innerHTML = `
                <p><b>Họ và Tên:</b> ${studentName}</p>
                <p><b>Lớp:</b> ${studentClass}</p>
            `;

            resultDetails.innerHTML = ''; 
            resultSection.style.display = 'block';
            document.querySelector('.submit-btn').style.display = 'none';

            // --- SỬA LỖI 2: VIẾT LẠI HOÀN TOÀN LOGIC CHẤM ĐIỂM VÀ HIỂN THỊ KẾT QUẢ ---
            
            // Chấm điểm và hiển thị kết quả Phần I
            shuffledPart1Data.forEach((q, index) => {
                const questionDiv = document.getElementById(q.id);
                const questionHeaderHTML = `Câu ${index + 1}: ${q.question}`;
                const selectedOption = document.querySelector(`input[name="${q.id}"]:checked`);
                const userAnswer = selectedOption ? selectedOption.value : null;
                const isCorrect = userAnswer === q.answer;

                if (isCorrect) {
                    score += 0.5;
                }

                // Tô màu đáp án
                questionDiv.querySelectorAll('.option-label').forEach(label => {
                    const input = label.querySelector('input');
                    if (input.value === q.answer) {
                        label.classList.add('correct');
                    }
                    if (userAnswer && input.value === userAnswer && !isCorrect) {
                        label.classList.add('incorrect');
                    }
                });

                // Tạo div kết quả chi tiết
                const resultItem = document.createElement('div');
                resultItem.classList.add('result-item', isCorrect ? 'correct' : 'incorrect');
                resultItem.innerHTML = `
                    <p><strong>${questionHeaderHTML}</strong></p>
                    <p>Đáp án của bạn: <span class="${isCorrect ? 'correct-answer-text' : 'your-answer-text'}">${userAnswer || 'Chưa chọn'}</span></p>
                    <p>Đáp án đúng: <span class="correct-answer-text">${q.answer}</span></p>
                    <div class="explanation"><p>Giải thích: ${q.explanation}</p></div>
                `;
                resultDetails.appendChild(resultItem);
            });

            // Chấm điểm và hiển thị kết quả Phần II
            shuffledPart2Data.forEach((q, index) => {
                const questionDiv = document.getElementById(q.id);
                const questionHeaderHTML = `Câu ${shuffledPart1Data.length + index + 1}: ${q.question}`;
                let correctCount = 0;
                let subResultHtml = '';

                q.sub_questions.forEach(sub => {
                    const selectedOption = document.querySelector(`input[name="${q.id}_${sub.id}"]:checked`);
                    const userAnswer = selectedOption ? selectedOption.value : null;
                    const isCorrect = userAnswer === sub.answer;
                    
                    if(isCorrect) {
                        correctCount++;
                    }

                    // Tô màu đáp án
                    questionDiv.querySelectorAll(`input[name="${q.id}_${sub.id}"]`).forEach(input => {
                        const label = input.closest('.option-label');
                        if (input.value === sub.answer) {
                            label.classList.add('correct');
                        }
                        if (userAnswer && input.value === userAnswer && !isCorrect) {
                            label.classList.add('incorrect');
                        }
                    });

                    subResultHtml += `
                        <p style="margin-left: 20px;">${sub.id}) ${sub.text}</p>
                        <p style="margin-left: 40px;">Đáp án của bạn: <span class="${isCorrect ? 'correct-answer-text' : 'your-answer-text'}">${userAnswer === 'true' ? 'Đúng' : userAnswer === 'false' ? 'Sai' : 'Chưa chọn'}</span></p>
                        <p style="margin-left: 40px;">Đáp án đúng: <span class="correct-answer-text">${sub.answer === 'true' ? 'Đúng' : 'Sai'}</span></p>
                        <div class="explanation" style="margin-left: 20px;"><p>Giải thích: ${sub.explanation}</p></div>
                    `;
                });
                
                const questionScore = getQuestionScore(correctCount);
                score += questionScore;

                const resultItem = document.createElement('div');
                resultItem.classList.add('result-item', correctCount === 4 ? 'correct' : 'incorrect');
                resultItem.innerHTML = `
                    <p><strong>${questionHeaderHTML}</strong></p>
                    ${subResultHtml}
                    <div style="margin-top: 15px; font-weight: bold;"><p>Số đáp án đúng: ${correctCount}/4</p><p>Điểm của câu này: ${questionScore.toFixed(2)}/1.00</p></div>
                `;
                resultDetails.appendChild(resultItem);
            });

            // Hiển thị tổng điểm cuối cùng
            const finalScore = score.toFixed(2);
            scoreElement.innerHTML = `<h2>Tổng điểm toàn bài của bạn là: ${finalScore}/10</h2>`;

            // --- GỬI DỮ LIỆU ĐẾN GOOGLE FORM (Phần này của bạn đã tốt, giữ nguyên) ---
            const studentNameValue = document.getElementById('studentName').value.trim();
            const studentClassValue = document.getElementById('studentClass').value.trim();
            
            const queryString = 
                `&${ENTRY_ID_NAME}=${encodeURIComponent(studentNameValue)}` +
                `&${ENTRY_ID_CLASS}=${encodeURIComponent(studentClassValue)}` +
                `&${ENTRY_ID_SCORE}=${encodeURIComponent(finalScore)}`;

            // Sử dụng fetch để gửi dữ liệu trong nền, không cần iframe
            fetch(GOOGLE_FORM_ACTION_URL, {
                method: 'POST',
                mode: 'no-cors', // Quan trọng: chế độ no-cors để không bị lỗi CORS
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: queryString
            }).catch(error => console.error('Error submitting form:', error));
            // --- KẾT THÚC GỬI DỮ LIỆU ---

            // Vô hiệu hóa các input và cuộn đến phần kết quả
            document.getElementById('quizForm').querySelectorAll('input').forEach(input => input.disabled = true);
            resultSection.scrollIntoView({ behavior: 'smooth' });
        }

        document.addEventListener('DOMContentLoaded', () => {
            buildQuiz();

            const startBtn = document.getElementById('startBtn');
            const userInfoContainer = document.getElementById('userInfoFormContainer');
            const quizContainer = document.getElementById('quizContainer');

            startBtn.addEventListener('click', function() {
                const nameValue = document.getElementById('studentName').value.trim();
                const classValue = document.getElementById('studentClass').value.trim();
                
                if (!nameValue || !classValue) { 
                    alert('Vui lòng điền đầy đủ Họ và Tên, và Lớp!');
                    return; 
                }

                // Cập nhật biến toàn cục
                studentName = nameValue;
                studentClass = classValue;
                
                userInfoContainer.style.display = 'none';
                quizContainer.style.display = 'block';

                startTimer();
            });
            
            document.getElementById('quizForm').addEventListener('submit', submitQuiz);
        });
    </script>
</body>
</html>
